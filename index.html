<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚°ãƒªã‚¹ãƒ­ä¹—è»Šå¸Œæœ›ã‚¢ãƒ—ãƒª</title>
    <style>
        /* --- å…±é€šã‚¹ã‚¿ã‚¤ãƒ« --- */
        :root {
            --primary-green: #4FA855; /* æ˜ã‚‹ã„ç·‘ */
            --bg-gray: #f2f2f7;
            --text-black: #333;
            --status-blue: #4169E1;
            --status-orange: #F5A623;
            --border-color: #ddd;
            --today-color: #ff9f43; /* ä»Šæ—¥ã®å¼·èª¿è‰² */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            max-width: 400px;
            height: 100%;
            background-color: white;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        header {
            background-color: var(--primary-green);
            color: white;
            text-align: center;
            font-weight: bold;
            padding: 50px 0 15px 0;
            font-size: 16px;
            transition: all 0.3s;
        }

        main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #fff;
            position: relative;
        }

        /* ãƒ“ãƒ¥ãƒ¼ï¼ˆç”»é¢ï¼‰ã®åˆ‡ã‚Šæ›¿ãˆç”¨ */
        .view-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            margin-top: 20px;
            font-weight: bold;
        }
        .section-title:first-child { margin-top: 0; }

        .info-box {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 14px;
            margin-bottom: 20px;
        }

        /* --- ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰ --- */
        .ride-item {
            background: white; border-radius: 12px; padding: 15px;
            margin-bottom: 12px; display: flex; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #eee;
            position: relative;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes centerFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .ride-item.selected { border: 1px solid var(--status-orange); background: #fcfcfc; }

        .item-close {
            position: absolute; top: 5px; right: 5px;
            color: #ccc; font-size: 20px; cursor: pointer;
            padding: 8px; line-height: 1; font-weight: bold;
        }
        .item-close:hover { color: #999; }

        .action-area {
            width: auto; display: flex; flex-direction: column; gap: 5px; justify-content: center;
            min-width: 60px; flex-shrink: 0;
        }
        .action-area-right {
            width: 80px; margin-left: auto; display: flex; flex-direction: column; gap: 5px; flex-shrink: 0;
        }
        .btn-add {
            background-color: var(--status-blue); color: white; border: none;
            border-radius: 6px; padding: 10px 0; font-size: 12px; font-weight: bold;
            cursor: pointer; width: 100%;
        }
        .status-box {
            border: 1px solid var(--status-orange); background-color: #fff5e6;
            color: var(--status-orange); border-radius: 6px; padding: 8px 0;
            text-align: center; font-size: 11px; font-weight: bold;
        }
        .status-box-disabled {
            background-color: #f5f5f5;
            color: #999; border-radius: 6px; padding: 8px 0;
            text-align: center; font-size: 11px; font-weight: bold;
            border: none;
        }
        .btn-remove-sm {
            background: #eee; border: none; color: #666; font-size: 10px;
            border-radius: 4px; padding: 4px 0; cursor: pointer; width: 100%; margin-top: 4px;
        }
        
        .ride-info { flex: 1; margin: 0 15px; }
        .ride-date { font-weight: bold; font-size: 14px; margin-bottom: 5px; display:block;}
        .ride-detail { font-size: 12px; color: #555; display: flex; align-items: center; gap: 5px; margin-bottom: 3px;}

        /* é‹è¡Œã‚¿ã‚¤ãƒ—ã®ãƒãƒƒã‚¸ */
        .type-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            background-color: #eee;
            color: #444;
            display: inline-block;
            margin-top: 2px;
            font-weight: normal;
        }

        /* --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å…±é€šã‚¹ã‚¿ã‚¤ãƒ« --- */
        .calendar-container { padding-bottom: 10px; background: #fff; border-radius:12px; }
                .calendar-grid-wrapper {
                    touch-action: pan-y;
                    position: relative;
                    overflow: hidden;
                }
        
        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ */
        .calendar-nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 10px; font-weight: bold; font-size: 16px; color: #333;
        }
        .nav-btn {
            background: none; border: none; font-size: 18px; color: var(--primary-green);
            cursor: pointer; padding: 5px 15px; font-weight: bold;
        }
        .nav-btn:hover { background-color: #f0f0f0; border-radius: 50%; }

        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr);
            row-gap: 15px; column-gap: 5px; text-align: center;
        }
        .day-label { font-size: 12px; color: #888; margin-bottom: 5px; }
        .day-label.sun { color: #e74c3c; }
        .day-label.sat { color: #3498db; }
        
        .date-cell {
            height: 45px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 50%; position: relative; font-size: 15px; color: #333; isolation: isolate; z-index: 1;
            transition: background 0.2s;
        }
        /* éå‹Ÿé›†æ—¥ã®ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ */
        .date-cell:not(.open):not(.requested):not(.selected):not(.today) {
            opacity: 0.4;
            color: #999;
        }
        .badge { font-size: 9px; line-height: 1; margin-top: 2px; font-weight: bold; }
        
        /* å‹Ÿé›†ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .date-cell.open { color: var(--status-blue); }
        .date-cell.open::after {
            content: ''; position: absolute; width: 36px; height: 36px;
            border: 2px solid var(--status-blue); border-radius: 50%;
            top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: -1;
        }
        .date-cell.open .badge { content: "å‹Ÿé›†ä¸­"; }

        /* å‹Ÿé›†çµ‚äº†ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .date-cell.closed { opacity: 0.5; color: #999; }
        .date-cell.closed .badge { content: "çµ‚äº†"; }

        /* å¸Œæœ›ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .date-cell.requested { color: white; }
        .date-cell.requested::after {
            content: ''; position: absolute; width: 40px; height: 40px;
            background-color: var(--status-orange); border-radius: 50%;
            top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: -1;
        }
        .date-cell.requested .badge { content: "å¸Œæœ›ä¸­"; }
        /* é¸æŠä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå‹Ÿé›†ä¸­ã‚’é¸æŠã—ãŸãŒã€ã¾ã å¸Œæœ›ã«è¿½åŠ ã—ã¦ã„ãªã„çŠ¶æ…‹ï¼‰ */
        .date-cell.selected { color: white; background-color: var(--status-blue); }
        .date-cell.selected::after {
            content: ''; position: absolute; width: 40px; height: 40px;
            background-color: var(--status-blue); border-radius: 50%;
            top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: -1;
        }
        .date-cell.selected .badge { content: "é¸æŠä¸­"; }
        /* æœ¬æ—¥ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆè¡¨ç¤ºãªã—ï¼‰ */
        .date-cell.today {
            font-weight: bold;
        }
        /* æœ¬æ—¥ã®ãƒãƒ¼ã‚¯ï¼ˆè¡¨ç¤ºãªã—ï¼‰ */
        /* .date-cell.today ã®è¦–è¦šçš„ãªå¼·èª¿ã‚’å‰Šé™¤ */
        /* å‹Ÿé›†ãŒãªã„æœˆã®ä»Šæ—¥ã¯å­˜åœ¨æ„Ÿã‚’å¼±ã‚ã‚‹ */
        .date-cell.today:not(.open) {
            opacity: 0.5;
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ãƒ»ãƒŠãƒ“ */
        .footer-action { padding: 15px 20px 30px 20px; background: white; border-top: 1px solid #eee; z-index: 10; }
        .btn { display: block; width: 100%; padding: 14px; border-radius: 25px; border: none; font-size: 15px; font-weight: bold; cursor: pointer; margin-bottom: 10px; text-align: center; }
        .btn-primary { background-color: #3840a0; color: white; box-shadow: 0 4px 10px rgba(56, 64, 160, 0.3); }
        .btn-outline { background: white; border: 1px solid #3840a0; color: #3840a0; }
        .btn-danger-outline { background: white; border: 1px solid #e74c3c; color: #e74c3c; }
        .btn-danger-fill { background: #e74c3c; color: white; }

        .nav-bar { display:flex; justify-content:space-around; padding:10px 0; background:var(--primary-green); color:white; font-size:10px; z-index: 20; }
        .nav-item { text-align:center; opacity: 0.6; cursor: pointer; transition: opacity 0.2s; min-width: 60px; }
        .nav-item.active { opacity: 1; font-weight: bold; }
        .nav-icon { font-size: 18px; margin-bottom: 2px; display: block; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay, .overlay-screen, .success-full-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; z-index: 100;
        }
        .modal-overlay { background: rgba(0,0,0,0.4); flex-direction: column; justify-content: flex-end; }
        .modal-overlay.active { display: flex; }
        
        .bottom-sheet {
            background: #f9f9f9; border-radius: 15px 15px 0 0; 
            max-height: 90%; height: 90%;
            display: flex; flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s ease-out; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }
        .modal-overlay.active .bottom-sheet { transform: translateY(0); }
        
        .sheet-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; background: white; border-radius: 15px 15px 0 0;}
        .sheet-content { flex: 1; overflow-y: auto; padding: 20px; }
        .sheet-footer { padding: 20px; background: white; border-top: 1px solid #eee; }

        .overlay-screen { background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 200; }
        .dialog-box { background: white; width: 85%; padding: 25px; border-radius: 15px; text-align: center; }
        
        .success-full-screen { background: white; flex-direction: column; align-items: center; justify-content: center; z-index: 150; }

        .empty-state-msg {
            text-align: center; color: #999; font-size: 13px; margin-top: 50px; margin-bottom: 50px;
        }

        /* ã‚·ãƒ•ãƒˆãƒãƒ¼å¼·èª¿ã‚¹ã‚¿ã‚¤ãƒ« */
        .shift-bar-indicator {
            display: inline-block;
            background: #FF6B6B;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 10px;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: #333; color: white; padding: 12px 20px;
            border-radius: 8px; font-size: 14px; z-index: 300;
            animation: centerFadeIn 0.3s ease-out;
        }

        /* æœªä¿å­˜ãƒãƒŠãƒ¼ */
        .unsaved-banner {
            background-color: #fff3cd; border: 1px solid #ffc107;
            color: #856404; padding: 12px 15px; border-radius: 6px;
            font-size: 13px; font-weight: 500; text-align: center;
            margin-bottom: 10px; display: none; animation: slideUp 0.3s ease-out;
        }
        .unsaved-banner.show {
            display: block;
        }
    </style>
</head>
<body>

<div id="app-container">
    <header id="app-header">ãƒ›ãƒ¼ãƒ </header>

    <main>
        <div id="view-home" class="view-section active">
            <div class="section-title">ä¹—è»Šå¸Œæœ›</div>
            <div class="info-box" id="user-plan-area">ä¹—è»Šå¸Œæœ›ã¯ã‚ã‚Šã¾ã›ã‚“</div>
            
            <div style="margin-top:30px; padding-bottom:20px;">
                <button class="btn btn-primary" onclick="switchTab('vote')">
                    ä¹—è»Šå¸Œæœ›ã®æŠ•ç¥¨ã¯ã“ã¡ã‚‰ã‹ã‚‰
                </button>
            </div>

            <div class="section-title">ã‚ãªãŸã®ç¢ºå®šã—ãŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</div>
            <div class="info-box" id="confirmed-schedule-area">ç¢ºå®šã—ãŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
        </div>

        <div id="view-vote" class="view-section">
            <div class="calendar-container" style="margin-bottom: 8px;">
                <div class="calendar-nav">
                    <button class="nav-btn" onclick="changeMonth(-1, 'vote')">ï¼œ</button>
                    <span id="vote-month-label" style="font-size: 13px;">2025å¹´11æœˆ</span>
                    <button class="nav-btn" onclick="changeMonth(1, 'vote')">ï¼</button>
                </div>
                <div class="calendar-grid-wrapper" id="vote-grid-wrapper">
                    <div class="calendar-grid" id="vote-calendar-grid">
                    </div>
                </div>
            </div>

            <div style="height: 1px; background: #eee; margin: 8px 0;"></div>

            <div id="vote-page-list" style="min-height: 60px; max-height: 120px; overflow-y: auto; font-size: 13px;">
                <div class="empty-state-msg">
                    ä¸Šã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨<br>è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                </div>
            </div>

            <div id="vote-hope-count-display" style="text-align: center; color: #3840a0; font-weight: bold; margin-bottom: 10px; font-size: 14px;">
                ç¾åœ¨ã€0ä»¶å¸Œæœ›ä¸­
            </div>

            <div style="margin-top:8px; padding-bottom:8px; display:flex; gap:8px;">
                <button class="btn" style="background:#ddd; color:#555; flex:1; padding: 8px;" onclick="cancelVoteTab()">æˆ»ã‚‹</button>
                <button class="btn btn-primary" style="flex:1; padding: 8px;" onclick="submitFromVoteTab()">
                    ç¢ºèªã™ã‚‹
                </button>
            </div>
        </div>

        <div id="view-confirm" class="view-section">
            <div class="section-title">ã“ã®å†…å®¹ã§é€ä¿¡ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</div>
            <div style="margin-top:10px;">
                <div style="background:#fff; padding:10px; border-radius:8px;">
                    <ul id="confirm-list" style="padding-left:18px; font-size:16px; margin:0;">
                    </ul>
                </div>
            </div>
            <div style="margin-top:16px; display:flex; gap:8px;">
                <button class="btn" style="background:#ddd; color:#555; flex:1;" onclick="cancelConfirmation()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" style="flex:1;" onclick="confirmSendFromConfirm()">é€ä¿¡ã™ã‚‹</button>
            </div>
        </div>

        <div id="view-record" class="view-section">
            <div class="section-title">å®Ÿç¸¾ä¸€è¦§</div>
            <div id="record-list">
                <div class="empty-state-msg">
                    å®Ÿç¸¾è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“
                </div>
            </div>
        </div>

        <div id="view-settings" class="view-section">
            <div class="section-title">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</div>
            <div class="ride-item">
                <div class="ride-info">
                    <span style="display: block; font-weight: bold; margin-bottom: 8px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</span>
                    <div class="ride-detail" id="settings-username">æœªè¨­å®š</div>
                </div>
            </div>

            <div class="section-title">é€šçŸ¥è¨­å®š</div>
            <div class="ride-item" style="display: flex; justify-content: space-between; align-items: center;">
                <span>ãƒ¡ãƒ¼ãƒ«é€šçŸ¥</span>
                <input type="checkbox" id="email-notification" checked style="width: 20px; height: 20px; cursor: pointer;">
            </div>
            <div class="ride-item" style="display: flex; justify-content: space-between; align-items: center;">
                <span>ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥</span>
                <input type="checkbox" id="push-notification" checked style="width: 20px; height: 20px; cursor: pointer;">
            </div>

            <div class="section-title">ãã®ä»–</div>
            <div class="ride-item" style="cursor: pointer; text-align: center; color: #3840a0;">
                <strong onclick="alert('ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0.0\næœ€çµ‚æ›´æ–°: 2025å¹´12æœˆ')">ã‚¢ãƒ—ãƒªæƒ…å ±</strong>
            </div>
            <div class="ride-item" style="cursor: pointer; text-align: center; color: #e74c3c;">
                <strong onclick="logoutApp()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</strong>
            </div>
        </div>
    </main>

    <div class="footer-action" id="footer-actions">
        </div>

    <div class="nav-bar">
        <div class="nav-item active" id="nav-home" onclick="switchTab('home')">
            <span class="nav-icon">ğŸ </span>ãƒ›ãƒ¼ãƒ 
        </div>
        <div class="nav-item" id="nav-record" onclick="switchTab('record')">
            <span class="nav-icon">ğŸ“–</span>è¨˜éŒ²
        </div>
        <div class="nav-item" id="nav-settings" onclick="switchTab('settings')">
            <span class="nav-icon">âš™ï¸</span>è¨­å®š
        </div>
    </div>

    <div class="modal-overlay" id="selection-modal">
        <div class="bottom-sheet">
            <div class="sheet-header">
                <span style="font-weight:bold; font-size:14px;">äºˆç´„ã®å¤‰æ›´</span>
                <button onclick="closeSelectionModal()" style="border:none; background:none; font-size:20px;">âœ•</button>
            </div>
            
            <div class="sheet-content">
                <div class="section-title" style="margin-top:0;">è¿½åŠ ãƒ»å¤‰æ›´ã™ã‚‹æ—¥ã‚’ã‚¿ãƒƒãƒ—</div>
                
                <div class="calendar-container">
                    <div class="calendar-nav">
                        <button class="nav-btn" onclick="changeMonth(-1, 'modal')">ï¼œ</button>
                        <span id="modal-month-label">2025å¹´11æœˆ</span>
                        <button class="nav-btn" onclick="changeMonth(1, 'modal')">ï¼</button>
                    </div>
                    <div class="calendar-grid-wrapper" id="modal-grid-wrapper">
                        <div class="calendar-grid" id="modal-calendar-grid">
                        </div>
                        </div>
                </div>

                <div style="height: 1px; background: #eee; margin: 20px 0;"></div>

                <div id="modal-page-list">
                    </div>
            </div>

            <div class="sheet-footer">
                <div id="unsaved-banner" class="unsaved-banner">âš ï¸ å¤‰æ›´ã¯ã¾ã é€ä¿¡ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
                <div id="hope-count-display" style="text-align: center; color: #3840a0; font-weight: bold; margin-bottom: 10px; font-size: 14px;">
                    ç¾åœ¨ã€0ä»¶å¸Œæœ›ä¸­
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn" style="background:#ddd; color:#555; width:30%;" onclick="closeSelectionModal()">æˆ»ã‚‹</button>
                    <button class="btn btn-primary" style="width:70%;" onclick="submitRequests()">å¤‰æ›´ã‚’ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <div class="success-full-screen" id="success-screen">
        <div style="font-size:40px; margin-bottom:20px;">âœ…</div>
        <h2 style="font-size:18px; margin:0 0 10px 0;">é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h2>
        <div style="width:80%; background:#f5f5f5; padding:15px; border-radius:10px; margin:30px 0; text-align:left;">
            <div style="font-size:12px; font-weight:bold; color:#3840a0;">é€ä¿¡å†…å®¹</div>
            <ul id="success-list" style="padding-left:20px; font-size:13px; margin:10px 0 0 0;"></ul>
        </div>
        <button class="btn" style="background:#e67e22; color:white; width:80%;" onclick="returnToHome()">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
    </div>

    <div class="overlay-screen" id="cancel-alert">
        <div class="dialog-box">
            <h3 style="font-size:16px;">å¸Œæœ›ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ</h3>
            <div style="display:flex; gap:10px; margin-top:25px;">
                <button class="btn" style="background:#eee; color:#333;" onclick="closeCancelAlert()">æˆ»ã‚‹</button>
                <button class="btn btn-danger-fill" onclick="confirmCancel()">ç ´æ£„ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ã‚«ã‚¹ã‚¿ãƒ ï¼šç·¨é›†ç ´æ£„ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæŠ•ç¥¨ç”»é¢ã®æˆ»ã‚‹ç”¨ï¼‰ -->
    <div class="overlay-screen" id="vote-cancel-confirm" style="display:none;">
        <div class="dialog-box">
            <h3 style="font-size:18px; margin:0 0 10px 0;">ã“ã®ã¾ã¾æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ</h3>
            <div style="font-size:13px; color:#333; line-height:1.6;">
                å¤‰æ›´å†…å®¹ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚<br>
                å…ƒã®å¸Œæœ›å†…å®¹ã«æˆ»ã‚Šã¾ã™ã€‚
            </div>
            <div style="display:flex; gap:10px; margin-top:20px; justify-content:flex-end;">
                <button class="btn btn-danger-fill" onclick="confirmCancelVote()">æˆ»ã‚‹ï¼ˆç ´æ£„ã™ã‚‹ï¼‰</button>
                <button class="btn" style="background:#eee; color:#333;" onclick="hideVoteCancelConfirm()">ç·¨é›†ã‚’ç¶šã‘ã‚‹</button>
            </div>
        </div>
    </div>

</div>

<script>
    /* --- å®šæ•°å®šç¾© --- */
    // æœ¬æ—¥ã‚’ 2026å¹´1æœˆ12æ—¥ ã¨ã™ã‚‹
    const TODAY_YEAR = 2026;
    const TODAY_MONTH = 1; // 1æœˆ
    const TODAY_DATE = 12;

    /* --- ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºé–¢æ•° --- */
    function showToast(message, duration = 2000) {
        // æ—¢å­˜ã®ãƒˆãƒ¼ã‚¹ãƒˆå‰Šé™¤
        const existingToast = document.querySelector('.toast');
        if (existingToast) existingToast.remove();
        
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s ease-out';
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    /* --- æœªä¿å­˜ãƒãƒŠãƒ¼åˆ¶å¾¡ --- */
    function showUnsavedBanner() {
        const banner = document.getElementById('unsaved-banner');
        if (banner) {
            banner.classList.add('show');
        }
    }

    function hideUnsavedBanner() {
        const banner = document.getElementById('unsaved-banner');
        if (banner) {
            banner.classList.remove('show');
        }
    }

    // å‹Ÿé›†ãƒ‡ãƒ¼ã‚¿ï¼ˆ2026å¹´1æœˆï¼‰
    const rideDetails = {
        5:  { date: "1æœˆ5æ—¥ (æœˆ)", time: "13:30 ~ 14:30", type: "ãƒ•ãƒªãƒ¼é‹è¡Œ", youbi: "æœˆ" },
        6:  { date: "1æœˆ6æ—¥ (ç«)", time: "10:00 ~ 11:30", type: "å¾ªç’°ãƒ«ãƒ¼ãƒˆ", youbi: "ç«" },
        7:  { date: "1æœˆ7æ—¥ (æ°´)", time: "14:30 ~ 15:30", type: "ãƒ•ãƒªãƒ¼é‹è¡Œ", youbi: "æ°´" },
        9:  { date: "1æœˆ9æ—¥ (é‡‘)", time: "10:00 ~ 11:30", type: "å¾ªç’°ãƒ«ãƒ¼ãƒˆ", youbi: "é‡‘" },
        12: { date: "1æœˆ12æ—¥ (æœˆ)", time: "10:00 ~ 12:00", type: "ãƒ•ãƒªãƒ¼é‹è¡Œ", youbi: "æœˆ" },
        13: { date: "1æœˆ13æ—¥ (ç«)", time: "10:00 ~ 11:30", type: "å¾ªç’°ãƒ«ãƒ¼ãƒˆ", youbi: "ç«" },
        16: { date: "1æœˆ16æ—¥ (é‡‘)", time: "10:00 ~ 11:30", type: "å¾ªç’°ãƒ«ãƒ¼ãƒˆ", youbi: "é‡‘" },
        20: { date: "1æœˆ20æ—¥ (ç«)", time: "10:00 ~ 11:30", type: "å¾ªç’°ãƒ«ãƒ¼ãƒˆ", youbi: "ç«" },
        21: { date: "1æœˆ21æ—¥ (æ°´)", time: "14:30 ~ 15:20", type: "ãƒ•ãƒªãƒ¼é‹è¡Œ", youbi: "æ°´" },
        23: { date: "1æœˆ23æ—¥ (é‡‘)", time: "10:00 ~ 11:30", type: "å¾ªç’°ãƒ«ãƒ¼ãƒˆ", youbi: "é‡‘" },
        26: { date: "1æœˆ26æ—¥ (æœˆ)", time: "10:00 ~ 11:20", type: "ãƒ•ãƒªãƒ¼é‹è¡Œ", youbi: "æœˆ" },
        28: { date: "1æœˆ28æ—¥ (æ°´)", time: "14:30 ~ 15:20", type: "ãƒ•ãƒªãƒ¼é‹è¡Œ", youbi: "æ°´" },
        30: { date: "1æœˆ30æ—¥ (é‡‘)", time: "10:00 ~ 11:30", type: "å¾ªç’°ãƒ«ãƒ¼ãƒˆ", youbi: "é‡‘" }
    };
    
    // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹æœˆï¼ˆ1æœˆï¼‰ã®ã¿IDã‚­ãƒ¼ã®é…åˆ—ã‚’ä½œã‚‹
    const openDatesJan2026 = Object.keys(rideDetails).map(Number).sort((a,b)=>a-b);
    
    // 2025å¹´12æœˆã§ä»¥å‰å‹Ÿé›†ã•ã‚Œã¦ã„ãŸæ—¥ä»˜ï¼ˆå‹Ÿé›†çµ‚äº†ã¨è¡¨ç¤ºã™ã‚‹ãŸã‚ã®å‚ç…§ï¼‰
    const closedDatesDec2025 = [2, 3, 5, 8, 9, 12, 16, 17, 19, 22, 23, 24, 26];

    // ç¢ºå®šã—ãŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆç®¡ç†è€…ãŒè¨­å®šï¼‰
    // å½¢å¼: { date: "æ—¥ä»˜", time: "æ™‚é–“", type: "é‹è¡Œç¨®åˆ¥", driver: "é‹è»¢æ‰‹", assistant: "æ·»ä¹—å“¡" }
    let confirmedSchedules = [
        { date: "2026å¹´1æœˆ16æ—¥ï¼ˆé‡‘ï¼‰", time: "10:00 ~ 11:30", type: "å¾ªç’°ãƒ«ãƒ¼ãƒˆ", driver: "éˆ´æœ¨ã•ã‚“", assistant: "ã‚ãªãŸ" },
        { date: "2026å¹´1æœˆ20æ—¥ï¼ˆç«ï¼‰", time: "14:00 ~ 15:30", type: "å¾ªç’°ãƒ«ãƒ¼ãƒˆ", driver: "ç”°ä¸­ã•ã‚“", assistant: "ã‚ãªãŸ" },
        { date: "2026å¹´1æœˆ23æ—¥ï¼ˆé‡‘ï¼‰", time: "10:00 ~ 11:30", type: "å¾ªç’°ãƒ«ãƒ¼ãƒˆ", driver: "ä½è—¤ã•ã‚“", assistant: "ã‚ãªãŸ" }
    ];

    /* --- çŠ¶æ…‹ç®¡ç† --- */
    let requestedDates = []; 
    let requestedDatesSnapshot = []; // æŠ•ç¥¨ã‚¿ãƒ–å…¥æ™‚ã®å¸Œæœ›çŠ¶æ…‹ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
    let tempSelectedDates = []; 
    let tempClickedDate = null; // é¸æŠä¸­ã®æ—¥ä»˜ï¼ˆã‚¯ãƒªãƒƒã‚¯å¾Œã€ã¾ã å¸Œæœ›ã«è¿½åŠ ã—ã¦ã„ãªã„çŠ¶æ…‹ï¼‰

    // å„ãƒ“ãƒ¥ãƒ¼ã”ã¨ã®ç¾åœ¨ã®è¡¨ç¤ºå¹´æœˆ
    let viewState = {
        home: { year: 2025, month: 11 }, // ãƒ›ãƒ¼ãƒ ã¯ä»Šæ—¥(11æœˆ)ã‹ã‚‰
        vote: { year: 2025, month: 11 }, // æŠ•ç¥¨ã‚‚ä»Šæ—¥ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆé·ç§»ã—ã¦12æœˆã¸ï¼‰
        modal: { year: 2025, month: 11 } 
    };

    // ä¸€æ™‚çš„ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèªã§ä½¿ã†ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜ç”¨
    let pendingCancelSnapshot = null;

    window.onload = () => {
        // åˆæœŸè¡¨ç¤º
        // æœ¬æ—¥ã«æœ€ã‚‚è¿‘ã„å‹Ÿé›†æ—¥æ™‚ã‚’è‡ªå‹•åˆ¤å®š
        const closestMonth = getClosestRecruitmentMonth();
        viewState.home = closestMonth;
        renderCalendar('home');
        updateFooter();
        updateUserPlanArea();
        updateConfirmedScheduleArea(); // ç¢ºå®šã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸè¡¨ç¤º
        
        // ã‚¿ãƒƒãƒã‚¹ãƒ©ã‚¤ãƒ‰æ©Ÿèƒ½ã®åˆæœŸåŒ–
        initCalendarSwipe('home');
        initCalendarSwipe('vote');
        initCalendarSwipe('modal');
    };

    /* --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ‰æ©Ÿèƒ½ --- */
    let swipeState = {
        startX: 0,
        startY: 0,
        isHorizontalSwipe: false
    };

    function initCalendarSwipe(viewName) {
        const wrapper = document.getElementById(`${viewName}-grid-wrapper`);
        if (!wrapper) return;
        
        wrapper.addEventListener('touchstart', (e) => {
            swipeState.startX = e.touches[0].clientX;
            swipeState.startY = e.touches[0].clientY;
            swipeState.isHorizontalSwipe = false;
        }, false);

        wrapper.addEventListener('touchmove', (e) => {
            const moveX = e.touches[0].clientX;
            const moveY = e.touches[0].clientY;
            const diffX = Math.abs(moveX - swipeState.startX);
            const diffY = Math.abs(moveY - swipeState.startY);
            
            // æ°´å¹³ã‚¹ãƒ©ã‚¤ãƒ—ã‚’ã‚ˆã‚Šå¼·ãåˆ¤å®šï¼ˆæ°´å¹³æ–¹å‘ã®ç§»å‹•ãŒã‚ˆã‚Šå¤§ãã„å ´åˆï¼‰
            if (diffX > 10 && diffX > diffY * 1.5) {
                swipeState.isHorizontalSwipe = true;
                e.preventDefault(); // å‚ç›´ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æŠ‘æ­¢
            }
        }, false);

        wrapper.addEventListener('touchend', (e) => {
            if (!swipeState.isHorizontalSwipe) return;
            
            const endX = e.changedTouches[0].clientX;
            const diff = endX - swipeState.startX;
            const threshold = 50; // ã‚¹ãƒ©ã‚¤ãƒ—åˆ¤å®šã®é–¾å€¤ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
            
            if (diff > threshold) {
                // å³ã‚¹ãƒ©ã‚¤ãƒ— â†’ å‰æœˆã¸
                changeMonth(-1, viewName);
            } else if (diff < -threshold) {
                // å·¦ã‚¹ãƒ©ã‚¤ãƒ— â†’ æ¬¡æœˆã¸
                changeMonth(1, viewName);
            }
        }, false);
    }
    /* --- æœ¬æ—¥ã«æœ€ã‚‚è¿‘ã„å‹Ÿé›†æ—¥æ™‚ã‚’å–å¾— --- */
    function getClosestRecruitmentMonth() {
        // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯2026å¹´1æœˆ
        // æœ¬æ—¥: 2026å¹´1æœˆ12æ—¥
        // æœ¬æ—¥ä»¥é™ã§æœ€åˆã®å‹Ÿé›†æœˆ â†’ 1æœˆï¼ˆå½“æœˆãŒå‹Ÿé›†æœˆï¼‰
        const recruitmentMonths = [{ year: 2026, month: 1 }];
        
        for (let record of recruitmentMonths) {
            // å½“æœˆã«æœ¬æ—¥ä»¥é™ã®å‹Ÿé›†ãŒã‚ã‚‹ï¼Ÿ
            if (record.year > TODAY_YEAR || 
                (record.year === TODAY_YEAR && record.month > TODAY_MONTH)) {
                return record;
            }
            if (record.year === TODAY_YEAR && record.month === TODAY_MONTH) {
                // å½“æœˆã§æœ¬æ—¥ä»¥é™ã®å‹Ÿé›†ã‚’æ¢ã™
                for (let dateKey of openDatesJan2026) {
                    if (dateKey >= TODAY_DATE) {
                        return record;
                    }
                }
            }
        }
        // ä»Šå¹´å†…ã«å‹Ÿé›†ãŒãªã„å ´åˆã¯1æœˆã‚’è¡¨ç¤º
        return { year: 2026, month: 1 };
    }

    /* --- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ --- */
    function switchTab(tabName) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const navElement = document.getElementById(`nav-${tabName}`);
        if (navElement) {
            navElement.classList.add('active');
        }

        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        // view-confirm ã¯ nav-item ãŒãªã„ãŸã‚ç›´æ¥å­˜åœ¨ãƒã‚§ãƒƒã‚¯
        const targetView = document.getElementById(`view-${tabName}`);
        if (targetView) targetView.classList.add('active');

        const footer = document.getElementById('footer-actions');
        if(tabName === 'home') {
            footer.style.display = 'block';
            document.getElementById('app-header').innerText = 'ãƒ›ãƒ¼ãƒ ';
            renderCalendar('home');
            updateConfirmedScheduleArea(); // ç¢ºå®šã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤ºæ›´æ–°
        } else if(tabName === 'vote') {
            footer.style.display = 'none';
            document.getElementById('app-header').innerText = 'æŠ•ç¥¨';
            // æŠ•ç¥¨ã‚¿ãƒ–åˆæœŸåŒ–
            initVoteScreen();
        } else if(tabName === 'confirm') {
            // ç¢ºèªç”»é¢ï¼ˆæŠ•ç¥¨â†’ç¢ºèªï¼‰
            footer.style.display = 'none';
            document.getElementById('app-header').innerText = 'ç¢ºèª';
            // renderã¯ä¸è¦ã€‚å†…å®¹ã¯ submitFromVoteTab ã§è¨­å®šã•ã‚Œã‚‹ã€‚
        } else if(tabName === 'record') {
            footer.style.display = 'none';
            document.getElementById('app-header').innerText = 'è¨˜éŒ²';
            loadRecordList();
        } else if(tabName === 'settings') {
            footer.style.display = 'none';
            document.getElementById('app-header').innerText = 'è¨­å®š';
            loadSettingsPage();
        }
    }

    /* --- è¨˜éŒ²ãƒšãƒ¼ã‚¸ç”¨é–¢æ•° --- */
    function loadRecordList() {
        const recordList = document.getElementById('record-list');
        // ã‚µãƒ³ãƒ—ãƒ«å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿
        const sampleRecords = [
            { date: '2025å¹´10æœˆ14æ—¥ï¼ˆç«ï¼‰', time: '10:00 ~ 12:30', type: 'å¾ªç’°ãƒ«ãƒ¼ãƒˆ', status: 'å®Œäº†' },
            { date: '2025å¹´11æœˆ17æ—¥ï¼ˆæœˆï¼‰', time: '11:30 ~ 13:30', type: 'å¾ªç’°ãƒ«ãƒ¼ãƒˆ', status: 'å®Œäº†' },
            { date: '2025å¹´11æœˆ26æ—¥ï¼ˆæ°´ï¼‰', time: '14:30 ~ 16:30', type: 'å¾ªç’°ãƒ«ãƒ¼ãƒˆ', status: 'å®Œäº†' },
            { date: '2025å¹´12æœˆ2æ—¥ (ç«)', time: '10:00 ~ 11:30', type: 'å¾ªç’°ãƒ«ãƒ¼ãƒˆ', status: 'å®Œäº†' },
            { date: '2025å¹´12æœˆ5æ—¥ (é‡‘)', time: '10:00 ~ 11:30', type: 'å¾ªç’°ãƒ«ãƒ¼ãƒˆ', status: 'å®Œäº†' },
        ];

        if(sampleRecords.length === 0) {
            recordList.innerHTML = '<div class="empty-state-msg">å®Ÿç¸¾è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
        } else {
            let html = '';
            sampleRecords.forEach(record => {
                html += `
                    <div class="ride-item">
                        <div class="action-area">
                            <div style="background: #4FA855; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px;">âœ” ${record.status}</div>
                        </div>
                        <div class="ride-info">
                            <span class="ride-date">ğŸ“… ${record.date}</span>
                            <div class="ride-detail">ğŸ•’ ${record.time}</div>
                            <div class="ride-detail"><span class="type-badge">ğŸ“ ${record.type}</span></div>
                        </div>
                    </div>
                `;
            });
            recordList.innerHTML = html;
        }
    }

    /* --- è¨­å®šãƒšãƒ¼ã‚¸ç”¨é–¢æ•° --- */
    function loadSettingsPage() {
        const usernameEl = document.getElementById('settings-username');
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆå®Ÿéš›ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‹ã‚‰å–å¾—ï¼‰
        usernameEl.innerText = 'ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢å¤ªéƒ';
    }

    function logoutApp() {
        if(confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
            alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
            switchTab('home');
        }
    }

    /* --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç† --- */
    function changeMonth(offset, viewName) {
        let s = viewState[viewName];
        s.month += offset;
        
        // å¹´ã¾ãŸãã®å‡¦ç†
        if (s.month > 12) {
            s.month = 1;
            s.year++;
        } else if (s.month < 1) {
            s.month = 12;
            s.year--;
        }
        
        // å†æç”»
        if (viewName === 'home') renderCalendar('home');
        else if (viewName === 'vote') initVoteScreen();
        else if (viewName === 'modal') renderModalCalendar();
    }

    /* --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ --- */
    // æŒ‡å®šã•ã‚ŒãŸãƒ“ãƒ¥ãƒ¼ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»ã™ã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼
    function renderCalendar(viewName) {
        const s = viewState[viewName];
        const gridId = `${viewName}-calendar-grid`;
        const labelId = `${viewName}-month-label`;
        
        // ãƒ©ãƒ™ãƒ«æ›´æ–°
        document.getElementById(labelId).innerText = `${s.year}å¹´${s.month}æœˆ`;

        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š
        const options = {
            year: s.year,
            month: s.month,
            targetId: `${viewName}-cal`,
            selectedDates: (viewName === 'home') ? [] : (viewName === 'vote') ? requestedDates : tempSelectedDates,
            isInteractive: (viewName !== 'home'), // homeä»¥å¤–ã¯ã‚¯ãƒªãƒƒã‚¯å¯èƒ½
            clickHandlerName: (viewName === 'vote') ? 'onVoteCalendarClick' : 'onModalCalendarClick'
        };

        document.getElementById(gridId).innerHTML = generateCalendarHTML(options);
    }

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼HTMLç”Ÿæˆã‚³ã‚¢é–¢æ•°
    function generateCalendarHTML(opt) {
        let html = '';
        
        // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
        const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
        dayNames.forEach((d, i) => {
            let cls = 'day-label'; if(i===0) cls+=' sun'; if(i===6) cls+=' sat';
            html += `<div class="${cls}">${d}</div>`;
        });

        // æœˆã®é–‹å§‹æ—¥ã¨æ—¥æ•°ã‚’è¨ˆç®—
        // new Date(year, monthIndex, 1) -> monthIndexã¯ 0=1æœˆ, 11=12æœˆ
        const firstDateObj = new Date(opt.year, opt.month - 1, 1);
        const startDayOfWeek = firstDateObj.getDay(); // 0(æ—¥) ~ 6(åœŸ)
        
        const lastDateObj = new Date(opt.year, opt.month, 0); // ç¿Œæœˆã®0æ—¥ç›®ï¼å½“æœˆã®æœ«æ—¥
        const daysInMonth = lastDateObj.getDate();

        // ç©ºç™½ã‚»ãƒ«ç”Ÿæˆ
        for(let i=0; i<startDayOfWeek; i++) html += `<div></div>`;

        // æ—¥ä»˜ã‚»ãƒ«ç”Ÿæˆ
        for(let day=1; day<=daysInMonth; day++) {
            let cls = 'date-cell';
            let inner = `${day}`;
            let clickAttr = '';
            
            // æœ¬æ—¥åˆ¤å®š
            const isToday = (opt.year === TODAY_YEAR && opt.month === TODAY_MONTH && day === TODAY_DATE);
            if (isToday) {
                cls += ' today';
            }

            // 2026å¹´1æœˆï¼šå‹Ÿé›†ä¸­ã®ãƒ‡ãƒ¼ã‚¿
            const isJan2026 = (opt.year === 2026 && opt.month === 1);
            const isDec2025 = (opt.year === 2025 && opt.month === 12);
            
            // çŠ¶æ…‹åˆ¤å®š
            const isOpen = isJan2026 && openDatesJan2026.includes(day);
            const isClosed = isDec2025 && closedDatesDec2025.includes(day); // 2025å¹´12æœˆã§ä»¥å‰å‹Ÿé›†ã•ã‚ŒãŸæ—¥ä»˜ã®ã¿
            const isReq = isJan2026 && opt.selectedDates.includes(day);
            const isClicked = tempClickedDate === day; // é¸æŠä¸­åˆ¤å®š

            if(isReq) {
                cls += ' requested';
                inner += '<div class="badge">å¸Œæœ›ä¸­</div>';
            } else if(isClicked) {
                cls += ' selected';
                inner += '<div class="badge">é¸æŠä¸­</div>';
            } else if(isOpen) {
                cls += ' open';
                inner += '<div class="badge">å‹Ÿé›†ä¸­</div>';
            } else if(isClosed) {
                cls += ' closed';
                inner += '<div class="badge">çµ‚äº†</div>';
            }

            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            if(opt.isInteractive && isOpen) {
                clickAttr = `onclick="${opt.clickHandlerName}(${day})" style="cursor:pointer;"`;
                clickAttr += ` id="${opt.targetId}-day-${day}"`;
            } else if(opt.isInteractive && isClosed) {
                // 2025å¹´12æœˆï¼ˆå‹Ÿé›†çµ‚äº†ï¼‰â†’ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                clickAttr = `onclick="showToast('ã“ã®æ—¥ã¯å‹Ÿé›†ãŒçµ‚äº†ã—ã¦ã„ã¾ã™')" style="cursor:not-allowed;"`;
            } else if(opt.isInteractive && isJan2026 && !isOpen) {
                // 2026å¹´1æœˆã ãŒå‹Ÿé›†æ—¥ã§ãªã„ â†’ ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºï¼ˆè¡¨ç¤ºæ–¹æ³•ã¯å¤‰æ›´ã—ãªã„ï¼‰
                // è¿½åŠ : ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚·ãƒ•ãƒˆãƒãƒ¼ï¼é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦åˆæœŸè¡¨ç¤ºã«æˆ»ã™
                clickAttr = `onclick="handleNonOpenClick(${day})" style="cursor:not-allowed;"`;
            } else {
                // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã§ãªã„å ´åˆï¼ˆãƒ›ãƒ¼ãƒ ç”»é¢ãªã©ï¼‰
                // ç‰¹åˆ¥ãªã‚¹ã‚¿ã‚¤ãƒ«ã¯ãªã—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
            }
            
            html += `<div class="${cls}" ${clickAttr}>${inner}</div>`;
        }
        return html;
    }


    /* --- ãƒ›ãƒ¼ãƒ ç”»é¢ --- */
    function updateUserPlanArea() {
        const area = document.getElementById('user-plan-area');
        if (requestedDates.length === 0) {
            area.innerHTML = 'ä¹—è»Šå¸Œæœ›ã¯ã‚ã‚Šã¾ã›ã‚“';
            area.style.textAlign = 'center'; area.style.background = '#f9f9f9';
        } else {
            let html = '';
            // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã¯12æœˆã®ã‚‚ã®ã¨ä»®å®šã—ã¦è¡¨ç¤º
            requestedDates.sort((a,b)=>a-b).forEach(d => {
                const info = rideDetails[d];
                if(info) {
                    html += `<div style="text-align:center; border-bottom:1px solid #eee; padding:12px 0; color:#333; font-size:16px; background-color:#f9f9f9; border-radius:6px; margin-bottom:8px;">
                                <span style="font-weight:bold;">${info.date}</span> â° ${info.time}
                                <span class="type-badge" style="margin-left:5px; font-size:14px; padding:4px 10px;">${info.type}</span>
                             </div>`;
                }
            });
            area.innerHTML = html;
            area.style.background = 'white';
        }
    }

    /* --- ç¢ºå®šã—ãŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤º --- */
    function updateConfirmedScheduleArea() {
        console.log('updateConfirmedScheduleArea() ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ');
        console.log('confirmedSchedules:', confirmedSchedules);
        const area = document.getElementById('confirmed-schedule-area');
        if (!area) {
            console.error('è¦ç´  confirmed-schedule-area ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }
        if (confirmedSchedules.length === 0) {
            console.log('é…åˆ—ãŒç©ºã§ã™');
            area.innerHTML = 'ç¢ºå®šã—ãŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“';
            area.style.textAlign = 'center'; area.style.background = '#f9f9f9';
        } else {
            console.log('ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ä»¶æ•°:', confirmedSchedules.length);
            let html = '';
            confirmedSchedules.forEach(schedule => {
                html += `<div style="text-align:left; border-bottom:1px solid #eee; padding:12px 0; color:#333; font-size:13px;">
                            <div style="font-weight:bold; margin-bottom:5px;">${schedule.date}</div>
                            <div style="margin-bottom:4px;">â° ${schedule.time}</div>
                            <div style="margin-bottom:8px;"><span class="type-badge">ğŸ“ ${schedule.type}</span></div>
                            <div style="background:#f5f5f5; padding:8px; border-radius:6px; font-size:12px;">
                                <div style="margin-bottom:3px;">ğŸš— é‹è»¢æ‰‹ï¼š${schedule.driver}</div>
                                <div>ğŸ‘¤ æ·»ä¹—å“¡ï¼š${schedule.assistant}</div>
                            </div>
                         </div>`;
            });
            area.innerHTML = html;
            area.style.background = 'white';
        }
    }

    function updateFooter() {
        const footer = document.getElementById('footer-actions');
        if (requestedDates.length > 0) {
            footer.innerHTML = `
                <button class="btn btn-outline" onclick="openSelectionModal()">ä¹—è»Šå¸Œæœ›ã®å¤‰æ›´ã‚’ã™ã‚‹</button>
                <button class="btn btn-danger-outline" onclick="openCancelAlert()">å¸Œæœ›å†…å®¹ã‚’ã™ã¹ã¦å–ã‚Šæ¶ˆã—</button>
            `;
        } else {
            footer.innerHTML = ``;
        }
    }

    /* --- æŠ•ç¥¨ã‚¿ãƒ– --- */
    function initVoteScreen() {
        // æŠ•ç¥¨ã‚¿ãƒ–ã«å…¥ã‚‹æ™‚ç‚¹ã§ã®å¸Œæœ›çŠ¶æ…‹ã‚’ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã«ä¿å­˜
        requestedDatesSnapshot = [...requestedDates];
        
        // æœ¬æ—¥ã«æœ€ã‚‚è¿‘ã„å‹Ÿé›†æ—¥æ™‚ã‹ã‚‰è¡¨ç¤ºé–‹å§‹ï¼ˆåˆå›ã®ã¿ï¼‰
        if (!viewState.vote || !viewState.vote.initialized) {
            const closestMonth = getClosestRecruitmentMonth();
            viewState.vote = closestMonth;
            viewState.vote.initialized = true;
        }
        
        renderCalendar('vote');

        const list = document.getElementById('vote-page-list');
        
        // åˆå›ã®ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        if (list.children.length === 0 || list.querySelector('.empty-state-msg')) {
             list.innerHTML = `
                <div class="empty-state-msg">
                    ä¸Šã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨<br>è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                </div>
            `;
        }
        
        // tempClickedDateã‚’ãƒªã‚»ãƒƒãƒˆ
        tempClickedDate = null;

        // å¸Œæœ›ä»¶æ•°ã‚’è¡¨ç¤º
        updateVoteHopeCountDisplay();
    }
    function onVoteCalendarClick(day) {
        if (requestedDates.includes(day)) {
            // å¸Œæœ›ä¸­ãªã‚‰å–ã‚Šæ¶ˆã—
            requestedDates = requestedDates.filter(d => d !== day);
            tempClickedDate = null;
            renderCalendar('vote');
            updateVotePageDisplay(day);
            updateVoteHopeCountDisplay(); // å¸Œæœ›ä»¶æ•°æ›´æ–°
            updateUserPlanArea(); // ãƒ›ãƒ¼ãƒ ã®å¸Œæœ›è¡¨ç¤ºæ›´æ–°
        } else if (openDatesJan2026.includes(day)) {
            // å‹Ÿé›†ä¸­ãªã‚‰å¸Œæœ›ä¸­ã«ã™ã‚‹
            requestedDates.push(day);
            tempClickedDate = null;
            renderCalendar('vote');
            updateVotePageDisplay(day);
            updateVoteHopeCountDisplay(); // å¸Œæœ›ä»¶æ•°æ›´æ–°
            updateUserPlanArea(); // ãƒ›ãƒ¼ãƒ ã®å¸Œæœ›è¡¨ç¤ºæ›´æ–°
        } else {
            // ãã‚Œä»¥å¤–ã¯å¾“æ¥é€šã‚Š
            tempClickedDate = day;
            renderCalendar('vote');
            updateVotePageDisplay(day);
        }
    }
    
    function updateVotePageDisplay(day) {
        const list = document.getElementById('vote-page-list');
        list.innerHTML = ''; // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
        
        const info = rideDetails[day];
        if (info) {
            const isSelected = requestedDates.includes(day);
            const cardDiv = document.createElement('div');
            const cardId = `card-vote-page-list-${day}`;
            cardDiv.id = cardId;
            cardDiv.className = isSelected ? 'ride-item selected' : 'ride-item';
            
            let leftActionHtml = '';
            let rightActionHtml = '';
            const toggleFunc = `toggleVoteCardState(${day})`;
            
            if(isSelected) {
                leftActionHtml = `<div class="status-box">âœ” å¸Œæœ›ä¸­</div>`;
                rightActionHtml = `<button class="btn-add" onclick="${toggleFunc}" style="background-color: var(--status-orange);">å–ã‚Šæ¶ˆã—</button>`;
            } else {
                leftActionHtml = `<div class="status-box-disabled">æœªå¸Œæœ›</div>`;
                rightActionHtml = `<button class="btn-add" onclick="${toggleFunc}">è¿½åŠ </button>`;
            }
            
            cardDiv.innerHTML = `
                <div class="action-area">${leftActionHtml}</div>
                <div class="ride-info">
                    <span class="ride-date">ğŸ“… ${info.date}</span>
                    <div class="ride-detail">ğŸ•’ ${info.time}</div>
                    <div class="ride-detail"><span class="type-badge">ğŸ“ ${info.type}</span></div>
                </div>
                <div class="action-area-right">${rightActionHtml}</div>
            `;
            
            list.appendChild(cardDiv);
        }
    }
    
    function toggleVoteCardState(day) {
        if(requestedDates.includes(day)) {
            requestedDates = requestedDates.filter(d => d !== day);
        } else {
            requestedDates.push(day);
        }
        
        updateVotePageDisplay(day);
        updateUserPlanArea();
        updateVoteCalendarCell(day); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ãƒ«å³æ™‚æ›´æ–°
        updateVoteHopeCountDisplay(); // å¸Œæœ›ä»¶æ•°æ›´æ–°
    }

    /* --- æŠ•ç¥¨ç”»é¢ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ãƒ«å³æ™‚æ›´æ–° --- */
    function updateVoteCalendarCell(day) {
        const cell = document.getElementById(`vote-cal-day-${day}`);
        if (!cell) return; // ã‚»ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å‡¦ç†çµ‚äº†
        
        const isRequested = requestedDates.includes(day);
        
        // ã‚¯ãƒ©ã‚¹ã‚’æ›´æ–°
        cell.className = 'date-cell';
        if (isRequested) {
            cell.classList.add('requested');
            cell.innerHTML = `${day}<div class="badge">å¸Œæœ›ä¸­</div>`;
        } else {
            cell.classList.add('open');
            cell.innerHTML = `${day}<div class="badge">å‹Ÿé›†ä¸­</div>`;
        }
        updateVoteHopeCountDisplay(); // å¸Œæœ›ä»¶æ•°æ›´æ–°
    }

    /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« (å¤‰æ›´) --- */
    function openSelectionModal() {
        tempSelectedDates = [...requestedDates];
        viewState.modal = { year: 2025, month: 11 }; // ä»Šæ—¥ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
        hideUnsavedBanner(); // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹æ™‚ã¯æœªä¿å­˜ãƒãƒŠãƒ¼éè¡¨ç¤º
        
        renderModalCalendar();

        const listContainer = document.getElementById('modal-page-list');
        listContainer.innerHTML = ''; 

        if (tempSelectedDates.length === 0) {
            listContainer.innerHTML = `<div class="empty-state-msg">è¿½åŠ ãƒ»å¤‰æ›´ã™ã‚‹æ—¥ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„</div>`;
        } else {
            tempSelectedDates.sort((a,b)=>a-b).forEach(day => {
                // ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºæ™‚ã«ã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDãŒå¿…è¦ã ãŒã€
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸç›´å¾Œã®æœˆ(11æœˆ)ã«ãã®æ—¥ä»˜(12æœˆã®ãƒ‡ãƒ¼ã‚¿)ãŒãªã„å ´åˆã€
                // ãƒã‚¤ãƒ©ã‚¤ãƒˆé€£æºã¯ã§ããªã„ãŒã‚«ãƒ¼ãƒ‰ã¯è¡¨ç¤ºã™ã‚‹ã€‚
                addCardToContainer(day, 'modal-page-list', 'modal-cal', false); 
            });
        }
        updateHopeCountDisplay(); // å¸Œæœ›ä»¶æ•°ã‚’è¡¨ç¤º
        document.getElementById('selection-modal').classList.add('active');
    }

    function renderModalCalendar() {
        renderCalendar('modal');
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†æç”»æ™‚ã«ã€ã™ã§ã«é¸æŠã•ã‚Œã¦ã„ã‚‹æ—¥ä»˜ãŒã‚ã‚Œã°ãƒã‚¤ãƒ©ã‚¤ãƒˆçŠ¶æ…‹ã‚’ç¶­æŒã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€
        // generateCalendarHTMLå†…ã§ isReq åˆ¤å®šã—ã¦ã„ã‚‹ã®ã§è‡ªå‹•çš„ã«åæ˜ ã•ã‚Œã‚‹ã€‚
    }
    
    function closeSelectionModal() {
        document.getElementById('selection-modal').classList.remove('active');
    }
    function onModalCalendarClick(day) {
            tempClickedDate = day;
            renderCalendar('modal'); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†æç”»ã—ã¦é¸æŠä¸­çŠ¶æ…‹ã‚’è¡¨ç¤º
        addCardToContainer(day, 'modal-page-list', 'modal-cal');
    }

    /* --- å…±é€š: ã‚«ãƒ¼ãƒ‰åˆ¶å¾¡ --- */
    function addCardToContainer(day, containerId, calendarPrefix, animate = true) {
        const listContainer = document.getElementById(containerId);
        const cardId = `card-${containerId}-${day}`;

        // æ—¢ã«ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆ
        if(document.getElementById(cardId)) {
            const existing = document.getElementById(cardId);
            existing.style.transition = 'transform 0.1s';
            existing.style.transform = 'scale(1.02)';
            setTimeout(()=> existing.style.transform='scale(1)', 100);
            return;
        }

        const emptyMsg = listContainer.querySelector('.empty-state-msg');
        if(emptyMsg) emptyMsg.remove();

        const info = rideDetails[day]; // ã“ã“ã¯å¸¸ã«ãƒ‡ãƒ¼ã‚¿å®šç¾©ã‹ã‚‰å¼•ã(12æœˆå‰æ)
        // ã‚‚ã—å°†æ¥çš„ã«è¤‡æ•°æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†ãªã‚‰ã€dayã ã‘ã§ãªãyear/monthã‚‚ã‚­ãƒ¼ã«ã™ã‚‹å¿…è¦ã‚ã‚Š
        
        const isSelected = tempSelectedDates.includes(day);

        const cardDiv = document.createElement('div');
        cardDiv.id = cardId;
        cardDiv.className = isSelected ? 'ride-item selected' : 'ride-item';
        if(!animate) cardDiv.style.animation = 'none';

        renderCardContent(cardDiv, day, isSelected, info, containerId, calendarPrefix);
        listContainer.appendChild(cardDiv);

        // ã‚«ãƒ¼ãƒ‰è¿½åŠ å¾Œã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚«ãƒ¼ãƒ‰ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
        setTimeout(() => {
            cardDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);

        // ã‚·ãƒ•ãƒˆãƒãƒ¼ãŒå‡ºã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã™ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’ä¸€åº¦ã ã‘è¡¨ç¤ºï¼ˆæŠ•ç¥¨ã‚¿ãƒ–ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å ´åˆï¼‰
        if ((containerId === 'vote-page-list' || containerId === 'modal-page-list') && 
            !listContainer.querySelector('.shift-bar-indicator')) {
            const indicator = document.createElement('div');
            indicator.className = 'shift-bar-indicator';
            indicator.textContent = 'â¬‡ï¸ ã‚·ãƒ•ãƒˆæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ';
            listContainer.insertBefore(indicator, listContainer.firstChild);
            
            // 3ç§’å¾Œã«è‡ªå‹•æ¶ˆå»
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.style.opacity = '0';
                    indicator.style.transform = 'translateY(-10px)';
                    indicator.style.transition = 'all 0.3s ease';
                    setTimeout(() => indicator.remove(), 300);
                }
            }, 3000);
        }
        showUnsavedBanner(); // æœªä¿å­˜ãƒãƒŠãƒ¼è¡¨ç¤º
    }

    function renderCardContent(element, day, isSelected, info, containerId, calendarPrefix) {
        let leftActionHtml = '';
        let rightActionHtml = '';
        const toggleFunc = `toggleCardState(${day}, '${element.id}', '${calendarPrefix}')`;
        const removeFunc = `removeCard(${day}, '${element.id}', '${containerId}')`;

        if(isSelected) {
            leftActionHtml = `<div class="status-box">âœ” å¸Œæœ›ä¸­</div>`;
            rightActionHtml = `<button class="btn-add" onclick="${toggleFunc}" style="background-color: var(--status-orange);">å–ã‚Šæ¶ˆã—</button>`;
        } else {
            leftActionHtml = `<div class="status-box-disabled">æœªå¸Œæœ›</div>`;
            rightActionHtml = `<button class="btn-add" onclick="${toggleFunc}">è¿½åŠ </button>`;
        }

        element.innerHTML = `
            <div class="action-area">${leftActionHtml}</div>
            <div class="ride-info">
                <span class="ride-date">ğŸ“… ${info.date}</span>
                <div class="ride-detail">ğŸ•’ ${info.time}</div>
                <div class="ride-detail"><span class="type-badge">ğŸ“ ${info.type}</span></div>
            </div>
            <div class="action-area-right">${rightActionHtml}</div>
            <div class="item-close" onclick="${removeFunc}">Ã—</div>
        `;
    }

    function toggleCardState(day, cardId, calendarPrefix) {
        if(tempSelectedDates.includes(day)) {
            tempSelectedDates = tempSelectedDates.filter(d => d !== day);
        } else {
            tempSelectedDates.push(day);
        }

        const card = document.getElementById(cardId);
        // æƒ…å ±ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã® rideDetails ã‹ã‚‰å–å¾— (12æœˆå›ºå®šãƒ‡ãƒ¼ã‚¿)
        const info = rideDetails[day];
        
        if(card) {
            card.className = tempSelectedDates.includes(day) ? 'ride-item selected' : 'ride-item';
            const containerId = card.parentElement.id; 
            renderCardContent(card, day, tempSelectedDates.includes(day), info, containerId, calendarPrefix);
        }
        updateCalendarCellDisplay(day, calendarPrefix);
        updateHopeCountDisplay(); // å¸Œæœ›ä»¶æ•°ã‚’æ›´æ–°
        showUnsavedBanner(); // æœªä¿å­˜ãƒãƒŠãƒ¼è¡¨ç¤º
    }

    function updateCalendarCellDisplay(day, prefix) {
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ãƒ«ã¯ã€ç¾åœ¨è¡¨ç¤ºä¸­ã®æœˆãŒã€Œ12æœˆã€ã§ã‚ã‚‹å ´åˆã®ã¿å­˜åœ¨ã™ã‚‹
        // DOMè¦ç´ ãŒãªã„å ´åˆï¼ˆ11æœˆè¡¨ç¤ºä¸­ãªã©ï¼‰ã¯ä½•ã‚‚ã—ãªã„
        const cell = document.getElementById(`${prefix}-day-${day}`);
        if(!cell) return;
        
        cell.className = 'date-cell'; 
        if(tempSelectedDates.includes(day)) {
            cell.classList.add('requested');
            cell.innerHTML = `${day}<div class="badge">å¸Œæœ›ä¸­</div>`;
        } else {
            cell.classList.add('open');
            cell.innerHTML = `${day}<div class="badge">å‹Ÿé›†ä¸­</div>`;
        }
    }

    /* --- å¸Œæœ›ä»¶æ•°è¡¨ç¤ºã®æ›´æ–° --- */
    function updateHopeCountDisplay() {
        const countElement = document.getElementById('hope-count-display');
        if (countElement) {
            const count = tempSelectedDates.length;
            countElement.textContent = `ç¾åœ¨ã€${count}ä»¶å¸Œæœ›ä¸­`;
            
            // ä»¶æ•°ãŒ0ã«ãªã£ãŸå ´åˆã¯è»½ãç‚¹ç¯ã€0ä»¥ä¸Šã®å ´åˆã¯å¼·èª¿
            if (count === 0) {
                countElement.style.color = '#999';
                countElement.style.fontWeight = 'normal';
            } else {
                countElement.style.color = '#3840a0';
                countElement.style.fontWeight = 'bold';
                countElement.style.animation = 'pulse 0.5s ease';
                setTimeout(() => countElement.style.animation = '', 500);
            }
        }
    }

    /* --- æŠ•ç¥¨ç”»é¢ã®å¸Œæœ›ä»¶æ•°è¡¨ç¤ºã®æ›´æ–° --- */
    function updateVoteHopeCountDisplay() {
        const countElement = document.getElementById('vote-hope-count-display');
        if (countElement) {
            const count = requestedDates.length;
            countElement.textContent = `ç¾åœ¨ã€${count}ä»¶å¸Œæœ›ä¸­`;
            
            // ä»¶æ•°ãŒ0ã«ãªã£ãŸå ´åˆã¯è»½ãç‚¹ç¯ã€0ä»¥ä¸Šã®å ´åˆã¯å¼·èª¿
            if (count === 0) {
                countElement.style.color = '#999';
                countElement.style.fontWeight = 'normal';
            } else {
                countElement.style.color = 'var(--status-orange)';
                countElement.style.fontWeight = 'bold';
                countElement.style.animation = 'pulse 0.5s ease';
                setTimeout(() => countElement.style.animation = '', 500);
            }
        }
    }

    function removeCard(day, cardId, containerId) {
        const card = document.getElementById(cardId);
        if(card) {
            card.style.opacity = '0';
            card.style.transform = 'translateX(20px)';
            setTimeout(() => {
                if(card.parentNode) card.parentNode.removeChild(card);
                const container = document.getElementById(containerId);
                if(container && container.children.length === 0) {
                     container.innerHTML = `<div class="empty-state-msg">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„</div>`;
                }
                showUnsavedBanner(); // æœªä¿å­˜ãƒãƒŠãƒ¼è¡¨ç¤º
            }, 300);
        }
    }

    /* --- é€ä¿¡å‡¦ç† --- */
    function submitFromVoteTab() {
        // æŠ•ç¥¨ã‚¿ãƒ–ã‹ã‚‰ã®é€ä¿¡ã¯æ—¢ã« requestedDates ã«åæ˜ ã•ã‚Œã¦ã„ã‚‹ã€‚
        // ã“ã“ã§ã¯æ—¢å­˜ã®é€ä¿¡å‡¦ç†ã‚’å‘¼ã¶å‰ã«ç¢ºèªç”»é¢ã¸é·ç§»ã™ã‚‹ã€‚
        const list = document.getElementById('confirm-list');
        let html = '';
        requestedDates.sort((a,b)=>a-b).forEach(d => {
            const i = rideDetails[d];
            if(i) {
                html += `<li style="margin-bottom:12px;">${i.date} ${i.time} <br><span style="font-size:14px; color:#666;">ï¼ˆ${i.type}ï¼‰</span></li>`;
            }
        });
        if(html === '') html = '<li>ï¼ˆäºˆç´„ãªã—ï¼‰</li>';
        list.innerHTML = html;

        // ç¢ºèªç”»é¢ã¸é·ç§»ï¼ˆé¸æŠæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã¯ãã®ã¾ã¾ä¿æŒï¼‰
        switchTab('confirm');
    }
    function cancelVoteTab() {
        // ç·¨é›†å†…å®¹ãŒã‚ã‚‹å ´åˆã¯ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¦ç ´æ£„ã™ã‚‹ã‹é¸ã°ã›ã‚‹
        const snapshot = Array.isArray(requestedDatesSnapshot) ? [...requestedDatesSnapshot].sort((a,b)=>a-b) : [];
        const current = Array.isArray(requestedDates) ? [...requestedDates].sort((a,b)=>a-b) : [];

        const isSame = (snapshot.length === current.length) && snapshot.every((v, i) => v === current[i]);

        if (!isSame) {
            // ä¿å­˜ã•ã‚ŒãŸã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿æŒã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ç¢ºèª
            pendingCancelSnapshot = Array.isArray(requestedDatesSnapshot) ? [...requestedDatesSnapshot] : [];
            showVoteCancelConfirm();
            return; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ±ºå®šã™ã‚‹ã¾ã§å‡¦ç†ã‚’ä¸­æ–­
        }

        // ç ´æ£„ï¼ˆã¾ãŸã¯å¤‰æ›´ãŒãªã„å ´åˆï¼‰â†’ å…ƒã®å¸Œæœ›çŠ¶æ…‹ã«æˆ»ã—ã¦ãƒ›ãƒ¼ãƒ ã¸
        requestedDates = Array.isArray(requestedDatesSnapshot) ? [...requestedDatesSnapshot] : [];
        updateUserPlanArea();
        switchTab('home');
    }
    function submitRequests() {
        finalizeSubmission();
    }

    // ç¢ºèªç”»é¢ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆã€æŠ•ç¥¨ç”»é¢ã¸æˆ»ã™ï¼ˆé¸æŠå†…å®¹ã¯ä¿æŒï¼‰
    function cancelConfirmation() {
        switchTab('vote');
    }

    // ç¢ºèªç”»é¢ã§ã€Œé€ä¿¡ã™ã‚‹ã€ã‚’æŠ¼ã—ãŸå ´åˆã€æ—¢å­˜ã®é€ä¿¡å‡¦ç†ã‚’ä½¿ã†
    function confirmSendFromConfirm() {
        // finalizeSubmission ã¯ tempSelectedDates ã‚’å‚ç…§ã—ã¦ requestedDates ã«åæ˜ ã™ã‚‹å®Ÿè£…ã®ãŸã‚ã€
        // æŠ•ç¥¨ç”»é¢ã§é¸æŠæ¸ˆã¿ã® requestedDates ã‚’ tempSelectedDates ã«ã‚³ãƒ”ãƒ¼ã—ã¦æ¸¡ã™
        tempSelectedDates = Array.isArray(requestedDates) ? [...requestedDates] : [];
        finalizeSubmission();
    }

    // éå¯¾è±¡ï¼ˆå‹Ÿé›†ä¸­ã§ã‚‚å¸Œæœ›ä¸­ã§ã‚‚ãªã„ï¼‰æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã—ãŸæ™‚ã®å…±é€šãƒãƒ³ãƒ‰ãƒ©
    function handleNonOpenClick(day) {
        // æ—¢å­˜ã®è¡¨ç¤ºï¼ˆä»•æ§˜ï¼‰ã‚’ç¶­æŒã—ã¦ãƒˆãƒ¼ã‚¹ãƒˆã‚’å‡ºã™
        showToast('ã“ã®æ—¥ã¯å‹Ÿé›†ãŒã‚ã‚Šã¾ã›ã‚“');

        // é¸æŠä¸­ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        tempClickedDate = null;

        // ä¸€æ™‚é¸æŠãƒ‡ãƒ¼ã‚¿ã¯ã‚¯ãƒªã‚¢ï¼ˆæ“ä½œã‚’ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«ã«æˆ»ã™ï¼‰
        tempSelectedDates = [];

        // æŠ•ç¥¨ç”»é¢ã®ã‚·ãƒ•ãƒˆãƒãƒ¼ï¼ˆæ—¥æ™‚è©³ç´°è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼‰ã‚’åˆæœŸè¡¨ç¤ºã«æˆ»ã™
        const voteList = document.getElementById('vote-page-list');
        if (voteList && document.getElementById('view-vote').classList.contains('active')) {
            voteList.innerHTML = `
                <div class="empty-state-msg">
                    ä¸Šã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨<br>è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                </div>
            `;
            // ã‚·ãƒ•ãƒˆãƒãƒ¼ç³»ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ãŒæ®‹ã£ã¦ã„ã‚Œã°å‰Šé™¤
            const indicator = voteList.querySelector('.shift-bar-indicator'); if(indicator) indicator.remove();
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã‚’æ›´æ–°ã—ã¦é¸æŠãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤
            renderCalendar('vote');
            return;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆé¸æŠå¤‰æ›´ï¼‰è¡¨ç¤ºä¸­ã®å ´åˆã‚‚åŒæ§˜ã«åˆæœŸåŒ–
        const modalList = document.getElementById('modal-page-list');
        if (modalList && document.getElementById('selection-modal').classList.contains('active')) {
            modalList.innerHTML = `<div class="empty-state-msg">è¿½åŠ ãƒ»å¤‰æ›´ã™ã‚‹æ—¥ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„</div>`;
            const indicator = modalList.querySelector('.shift-bar-indicator'); if(indicator) indicator.remove();
            renderCalendar('modal');
            updateHopeCountDisplay();
            hideUnsavedBanner();
            return;
        }
    }
    
    /* --- ã‚«ã‚¹ã‚¿ãƒ ï¼šæŠ•ç¥¨ç”»é¢ã®æˆ»ã‚‹ï¼ˆç ´æ£„ï¼‰ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« --- */
    function showVoteCancelConfirm() {
        const modal = document.getElementById('vote-cancel-confirm');
        if (modal) modal.style.display = 'flex';
    }

    function hideVoteCancelConfirm() {
        const modal = document.getElementById('vote-cancel-confirm');
        if (modal) modal.style.display = 'none';
        pendingCancelSnapshot = null;
    }

    function confirmCancelVote() {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç ´æ£„ã‚’é¸æŠã—ãŸå ´åˆã®å‡¦ç†
        if (Array.isArray(pendingCancelSnapshot)) {
            requestedDates = [...pendingCancelSnapshot];
        } else {
            requestedDates = [];
        }
        tempSelectedDates = [];
        hideVoteCancelConfirm();
        updateUserPlanArea();
        switchTab('home');
    }
    function finalizeSubmission() {
        requestedDates = [...tempSelectedDates];
        closeSelectionModal(); 
        hideUnsavedBanner(); // æœªä¿å­˜ãƒãƒŠãƒ¼éè¡¨ç¤º
        
        const list = document.getElementById('success-list');
        let html = '';
        requestedDates.sort((a,b)=>a-b).forEach(d => {
            const i = rideDetails[d];
            if(i) {
                html += `<li style="margin-bottom:5px;">
                            ${i.date} ${i.time} 
                            <br><span style="font-size:11px; color:#666;">ï¼ˆ${i.type}ï¼‰</span>
                         </li>`;
            }
        });
        if(html === '') html = '<li>ï¼ˆäºˆç´„ãªã—ï¼‰</li>';
        list.innerHTML = html;

        document.getElementById('success-screen').style.display = 'flex';
        
        // é€ä¿¡å¾Œã¯ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹éš›ã€ãƒ›ãƒ¼ãƒ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚‚æœ€æ–°åŒ–
        renderCalendar('home');
        updateUserPlanArea();
        updateFooter();
    }

    function returnToHome() {
        document.getElementById('success-screen').style.display = 'none';
        switchTab('home'); 
    }
    function openCancelAlert() {
        document.getElementById('cancel-alert').style.display = 'flex';
    }
    function closeCancelAlert() {
        document.getElementById('cancel-alert').style.display = 'none';
    }
    function confirmCancel() {
        requestedDates = [];
        closeCancelAlert();
        renderCalendar('home');
        updateUserPlanArea();
        updateFooter();
    }
</script>
</body>
</html>